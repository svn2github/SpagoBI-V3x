<?xml version="1.0"?>

<project name="Deploy" default="applyPortalConfiguration">

	<description>
		Setup project properly for the target deployment environment (web or portal)
	</description>
	
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
	<!--   IMPORT PROPERTY FILE DEFINITIONS		                                        -->
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ --> 
	<!-- Load all the default properties, and any the user wants    					-->
	<!-- to contribute (without having to type -D or edit this file 					-->
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
	<property file="project.properties" />
	
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
	<!--  APPLY PORTAL CONFIGURATION				                                    -->
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ --> 
	<!-- Task to setup project properly for deployment into a portal container			--> 
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
	<target name="applyPortalConfiguration" 
			description="Task to setup project properly for deployment into a portal container">
		
		<replace file="${conf.dir}/config/spagobi.xml">
			<replacefilter 
				token='&lt;SPAGOBI-MODE mode="WEB"/&gt;' 
				value='&lt;SPAGOBI-MODE mode="PORTLET"/&gt;'/>	
		</replace>
		
		<!-- Comment the initializers inside the file initializer.xml -->
		<replace file="${conf.dir}/config/initializers.xml">
			<replacefilter 
				token='&lt;INITIALIZER class="it.eng.spagobi.security.init.SecurityInitializer" config="" /&gt;' 
				value='&lt;!-- INITIALIZER class="it.eng.spagobi.security.init.SecurityInitializer" config="" --&gt;'/>	
		</replace>
		
		<replace file="${conf.dir}/config/initializers.xml">
			<replacefilter 
				token='&lt;INITIALIZER class="it.eng.spagobi.analiticalmodel.functionalitytree.init.TreeInitializer" config="SPAGOBI.TREE_INITIALIZATION" /&gt;' 
				value='&lt;!-- INITIALIZER class="it.eng.spagobi.analiticalmodel.functionalitytree.init.TreeInitializer" config="SPAGOBI.TREE_INITIALIZATION" --&gt;' />	
		</replace>
		
		<!-- Uncomment PortletApplication Listener in file web.xm -->
		<replace file="${webinf.dir}/web.xml">
			<replacevalue><![CDATA[
<listener>
<listener-class>org.exoplatform.services.portletcontainer.impl.servlet.PortletApplicationListener</listener-class>
</listener>]]></replacevalue>
					
		<replacetoken><![CDATA[<!--
<listener>
<listener-class>org.exoplatform.services.portletcontainer.impl.servlet.PortletApplicationListener</listener-class>
</listener>
-->]]></replacetoken>
		</replace>
		
		<!-- Uncomment PortletWrapper servlet in file web.xm -->
		<replace file="${webinf.dir}/web.xml">
			<replacevalue><![CDATA[
<servlet>
<servlet-name>PortletWrapper</servlet-name>
<servlet-class>org.exoplatform.services.portletcontainer.impl.servlet.ServletWrapper</servlet-class>
</servlet>]]></replacevalue>
									
			<replacetoken><![CDATA[<!-- 
<servlet>
<servlet-name>PortletWrapper</servlet-name>
<servlet-class>org.exoplatform.services.portletcontainer.impl.servlet.ServletWrapper</servlet-class>
</servlet>
-->]]></replacetoken>
		</replace>	
		
		<!-- Uncomment PortletWrapper servlet in file web.xm -->
		<replace file="${webinf.dir}/web.xml">
			<replacevalue><![CDATA[
<servlet-mapping>
<servlet-name>PortletWrapper</servlet-name>
<url-pattern>/PortletWrapper</url-pattern>
</servlet-mapping>]]></replacevalue>
											
		<replacetoken><![CDATA[<!-- 
<servlet-mapping>
<servlet-name>PortletWrapper</servlet-name>
<url-pattern>/PortletWrapper</url-pattern>
</servlet-mapping>
-->]]></replacetoken>
	</replace>	
	
		<!-- Comment inclusion in file master.xm -->
			<replace file="${conf.dir}/master.xml">
				<replacevalue><![CDATA[<!--
<CONFIGURATOR path="/WEB-INF/conf/webapp/messages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/modules.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/pages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/presentation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/publishers.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/authorizations.xml" /> 
<CONFIGURATOR path="/WEB-INF/conf/webapp/technical_user_menu.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/final_users_functionalities.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/actions.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/business_map.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/validation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/ldap_authorizations.xml" />
-->]]></replacevalue>
													
				<replacetoken><![CDATA[
<CONFIGURATOR path="/WEB-INF/conf/webapp/messages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/modules.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/pages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/presentation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/publishers.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/authorizations.xml" /> 
<CONFIGURATOR path="/WEB-INF/conf/webapp/technical_user_menu.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/final_users_functionalities.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/actions.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/business_map.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/validation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/ldap_authorizations.xml" />]]></replacetoken>
		</replace>	
		
		
	<replace file="${conf.dir}/config/spagobi.xml">
		<replacetoken><![CDATA[
<SECURITY>
<PORTAL-SECURITY-INIT-CLASS>it.eng.spagobi.security.init.XmlSecurityProviderInit</PORTAL-SECURITY-INIT-CLASS>
<PORTAL-SECURITY-CLASS className="it.eng.spagobi.security.XmlSecurityInfoProviderImpl">
<CONFIG />
</PORTAL-SECURITY-CLASS>
<USER-PROFILE-FACTORY-CLASS className="it.eng.spagobi.security.XmlSecurityServiceSupplierImpl" />
<ROLE-NAME-PATTERN-FILTER>.*</ROLE-NAME-PATTERN-FILTER>
<ROLE-TYPE-PATTERNS>
<ADMIN-PATTERN>/spagobi/admin</ADMIN-PATTERN>
<DEV_ROLE-PATTERN>/spagobi/dev</DEV_ROLE-PATTERN>
<TEST_ROLE-PATTERN>/spagobi/test</TEST_ROLE-PATTERN>
<MODEL_ADMIN-PATTERN>/spagobi/modeladmin</MODEL_ADMIN-PATTERN>
</ROLE-TYPE-PATTERNS>
</SECURITY>]]></replacetoken>
													
				<replacevalue><![CDATA[
<SECURITY>
<PORTAL-SECURITY-INIT-CLASS>it.eng.spagobi.security.init.ExoPortalSecurityProviderInit</PORTAL-SECURITY-INIT-CLASS>
<PORTAL-SECURITY-CLASS className="it.eng.spagobi.security.ExoSecurityProviderImpl">
<CONFIG>
<NAME_PORTAL_APPLICATION>portal</NAME_PORTAL_APPLICATION>
</CONFIG>
</PORTAL-SECURITY-CLASS>
<USER-PROFILE-FACTORY-CLASS className="it.eng.spagobi.security.ExoUserProfileImpl">
</USER-PROFILE-FACTORY-CLASS>
<ROLE-NAME-PATTERN-FILTER>/spagobi/.*</ROLE-NAME-PATTERN-FILTER>
<ROLE-TYPE-PATTERNS>
<ADMIN-PATTERN>/spagobi/admin</ADMIN-PATTERN>
<DEV_ROLE-PATTERN>/spagobi/dev</DEV_ROLE-PATTERN>
<TEST_ROLE-PATTERN>/spagobi/test</TEST_ROLE-PATTERN>
<MODEL_ADMIN-PATTERN>/spagobi/modeladmin</MODEL_ADMIN-PATTERN>
</ROLE-TYPE-PATTERNS>
</SECURITY>]]></replacevalue>
	</replace>
		
	</target>
	
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
	<!--  APPLY WEB CONFIGURATION				                                    	-->
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ --> 
	<!-- Task to setup project properly for deployment as pure web application 			--> 
	<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
	<target name="applyWebConfiguration" 
			description="Task to setup project properly for deployment as pure web application">
		
		
		<replace file="${conf.dir}/config/spagobi.xml">
			<replacefilter 
				token='&lt;SPAGOBI-MODE mode="PORTLET"/&gt;' 
				value='&lt;SPAGOBI-MODE mode="WEB"/&gt;'/>		
		</replace>
		
		
		<!-- Uncomment the initializers in file initializer.xm -->
		<replace file="${conf.dir}/config/initializers.xml">
			<replacefilter 
				value='&lt;INITIALIZER class="it.eng.spagobi.security.init.SecurityInitializer" config="" /&gt;' 
				token='&lt;!-- INITIALIZER class="it.eng.spagobi.security.init.SecurityInitializer" config="" --&gt;'/>	
		</replace>
		
		<replace file="${conf.dir}/config/initializers.xml">
			<replacefilter 
				value='&lt;INITIALIZER class="it.eng.spagobi.analiticalmodel.functionalitytree.init.TreeInitializer" config="SPAGOBI.TREE_INITIALIZATION" /&gt;' 
				token='&lt;!-- INITIALIZER class="it.eng.spagobi.analiticalmodel.functionalitytree.init.TreeInitializer" config="SPAGOBI.TREE_INITIALIZATION" --&gt;' />	
		</replace>
		
		<!-- Comment PortletApplication Listener in file web.xm -->
		<replace file="${webinf.dir}/web.xml">
			<replacetoken><![CDATA[
<listener>
<listener-class>org.exoplatform.services.portletcontainer.impl.servlet.PortletApplicationListener</listener-class>
</listener>]]></replacetoken>
					
		<replacevalue><![CDATA[<!-- 
<listener>
<listener-class>org.exoplatform.services.portletcontainer.impl.servlet.PortletApplicationListener</listener-class>
</listener>
-->]]></replacevalue>
		</replace>
		
		<!-- Comment PortletWrapper servlet in file web.xm -->
		<replace file="${webinf.dir}/web.xml">
			<replacetoken><![CDATA[
<servlet>
<servlet-name>PortletWrapper</servlet-name>
<servlet-class>org.exoplatform.services.portletcontainer.impl.servlet.ServletWrapper</servlet-class>
</servlet>]]></replacetoken>
							
		<replacevalue><![CDATA[<!-- 
<servlet>
<servlet-name>PortletWrapper</servlet-name>
<servlet-class>org.exoplatform.services.portletcontainer.impl.servlet.ServletWrapper</servlet-class>
</servlet>
-->]]></replacevalue>
		</replace>	
		
		<!-- Comment PortletWrapper servlet-mapping in file web.xm -->
		<replace file="${webinf.dir}/web.xml">
			<replacetoken><![CDATA[
<servlet-mapping>
<servlet-name>PortletWrapper</servlet-name>
<url-pattern>/PortletWrapper</url-pattern>
</servlet-mapping>]]></replacetoken>
												
			<replacevalue><![CDATA[<!-- 
<servlet-mapping>
<servlet-name>PortletWrapper</servlet-name>
<url-pattern>/PortletWrapper</url-pattern>
</servlet-mapping>
-->]]></replacevalue>
	</replace>	
		
		<!-- Uncomment inclusion in file master.xm -->
			<replace file="${conf.dir}/master.xml">
				<replacetoken><![CDATA[<!--
<CONFIGURATOR path="/WEB-INF/conf/webapp/messages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/modules.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/pages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/presentation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/publishers.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/authorizations.xml" /> 
<CONFIGURATOR path="/WEB-INF/conf/webapp/technical_user_menu.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/final_users_functionalities.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/actions.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/business_map.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/validation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/ldap_authorizations.xml" />
-->]]></replacetoken>
													
				<replacevalue><![CDATA[
<CONFIGURATOR path="/WEB-INF/conf/webapp/messages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/modules.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/pages.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/presentation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/publishers.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/authorizations.xml" /> 
<CONFIGURATOR path="/WEB-INF/conf/webapp/technical_user_menu.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/final_users_functionalities.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/actions.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/business_map.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/validation.xml" />
<CONFIGURATOR path="/WEB-INF/conf/webapp/ldap_authorizations.xml" />]]></replacevalue>
		</replace>	
		
		<replace file="${conf.dir}/config/spagobi.xml">
			<replacevalue><![CDATA[
<SECURITY>
<PORTAL-SECURITY-INIT-CLASS>it.eng.spagobi.security.init.XmlSecurityProviderInit</PORTAL-SECURITY-INIT-CLASS>
<PORTAL-SECURITY-CLASS className="it.eng.spagobi.security.XmlSecurityInfoProviderImpl">
<CONFIG />
</PORTAL-SECURITY-CLASS>
<USER-PROFILE-FACTORY-CLASS className="it.eng.spagobi.security.XmlSecurityServiceSupplierImpl" />
<ROLE-NAME-PATTERN-FILTER>.*</ROLE-NAME-PATTERN-FILTER>
<ROLE-TYPE-PATTERNS>
<ADMIN-PATTERN>/spagobi/admin</ADMIN-PATTERN>
<DEV_ROLE-PATTERN>/spagobi/dev</DEV_ROLE-PATTERN>
<TEST_ROLE-PATTERN>/spagobi/test</TEST_ROLE-PATTERN>
<MODEL_ADMIN-PATTERN>/spagobi/modeladmin</MODEL_ADMIN-PATTERN>
</ROLE-TYPE-PATTERNS>
</SECURITY>]]></replacevalue>
														
					<replacetoken><![CDATA[
<SECURITY>
<PORTAL-SECURITY-INIT-CLASS>it.eng.spagobi.security.init.ExoPortalSecurityProviderInit</PORTAL-SECURITY-INIT-CLASS>
<PORTAL-SECURITY-CLASS className="it.eng.spagobi.security.ExoSecurityProviderImpl">
<CONFIG>
<NAME_PORTAL_APPLICATION>portal</NAME_PORTAL_APPLICATION>
</CONFIG>
</PORTAL-SECURITY-CLASS>
<USER-PROFILE-FACTORY-CLASS className="it.eng.spagobi.security.ExoUserProfileImpl">
</USER-PROFILE-FACTORY-CLASS>
<ROLE-NAME-PATTERN-FILTER>/spagobi/.*</ROLE-NAME-PATTERN-FILTER>
<ROLE-TYPE-PATTERNS>
<ADMIN-PATTERN>/spagobi/admin</ADMIN-PATTERN>
<DEV_ROLE-PATTERN>/spagobi/dev</DEV_ROLE-PATTERN>
<TEST_ROLE-PATTERN>/spagobi/test</TEST_ROLE-PATTERN>
<MODEL_ADMIN-PATTERN>/spagobi/modeladmin</MODEL_ADMIN-PATTERN>
</ROLE-TYPE-PATTERNS>
</SECURITY>]]></replacetoken>
		</replace>		
		
	</target>
		

	
</project>
	