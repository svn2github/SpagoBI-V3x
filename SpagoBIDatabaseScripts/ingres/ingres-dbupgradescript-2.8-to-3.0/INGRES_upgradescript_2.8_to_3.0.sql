INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Groovy','Groovy','SCRIPT_TYPE','Script Type','Script Type');\p\g
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Javascript','Javascript','SCRIPT_TYPE','Script Type','Script Type');\p\g
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('File','SbiFileDataSet','DATA_SET_TYPE','Data Set Type','SbiFileDataSet');\p\g
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Query','SbiQueryDataSet','DATA_SET_TYPE','Data Set Type','SbiQueryDataSet');\p\g
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Java Class','SbiJClassDataSet','DATA_SET_TYPE','Data Set Type','SbiJClassDataSet');\p\g
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Web Service','SbiWSDataSet','DATA_SET_TYPE','Data Set Type','SbiWSDataSet');\p\g
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Script','SbiScriptDataSet','DATA_SET_TYPE','Data Set Type','SbiScriptDataSet');\p\g
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Qbe','SbiQbeDataSet','DATA_SET_TYPE','Data Set Type','SbiQbeDataSet');\p\g

CREATE SEQUENCE SBI_DATA_SET_HIST_SEQ;\p\g
CREATE TABLE SBI_DATA_SET_HISTORY (
	DS_H_ID 	   INTEGER NOT NULL with default next value for SBI_DATA_SET_HIST_SEQ,
	DS_ID 		   INTEGER NOT NULL,
	ACTIVE		   smallint NOT NULL,
	VERSION_NUM	   INTEGER NOT NULL,
	OBJECT_TYPE    VARCHAR(50),
	DS_METADATA    VARCHAR(2000),
	PARAMS         VARCHAR(1000),
	CATEGORY_ID    INTEGER,
    FILE_NAME	   VARCHAR(300),
    QUERY   	   nvarchar,
    DATA_SOURCE_ID INTEGER,
    ADRESS   	   VARCHAR(250),
    OPERATION      VARCHAR(50),
    JCLASS_NAME    VARCHAR(100),
    LANGUAGE_SCRIPT VARCHAR(50),
	SCRIPT   	   nvarchar,
	JSON_QUERY     nvarchar,
	DATAMARTS	   VARCHAR(400),
    TRANSFORMER_ID INTEGER,
    PIVOT_COLUMN   VARCHAR(50),
	PIVOT_ROW      VARCHAR(50),
	PIVOT_VALUE    VARCHAR(50),
	NUM_ROWS	   smallint default 0,	
	USER_IN              VARCHAR(100) NOT NULL,
	TIME_IN              TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	META_VERSION         VARCHAR(100),
	SBI_VERSION_IN       VARCHAR(10),
    PRIMARY KEY (DS_H_ID)
);\p\g

ALTER TABLE SBI_DATA_SET_HISTORY ADD CONSTRAINT FK_SBI_DATA_SET_T  FOREIGN KEY  ( TRANSFORMER_ID ) REFERENCES SBI_DOMAINS ( VALUE_ID ) ON DELETE CASCADE;\p\g
ALTER TABLE SBI_DATA_SET_HISTORY ADD CONSTRAINT FK_SBI_DATA_SET_CAT  FOREIGN KEY  (CATEGORY_ID) REFERENCES SBI_DOMAINS (VALUE_ID) ON DELETE CASCADE ON UPDATE RESTRICT;\p\g
ALTER TABLE SBI_DATA_SET_HISTORY ADD CONSTRAINT FK_SBI_DATA_SET_DS  FOREIGN KEY  ( DATA_SOURCE_ID ) REFERENCES SBI_DATA_SOURCE ( DS_ID ) ON DELETE CASCADE;\p\g
ALTER TABLE SBI_DATA_SET_HISTORY ADD CONSTRAINT FK_SBI_DATA_SET_DS2  FOREIGN KEY  (DS_ID) REFERENCES SBI_DATA_SET (DS_ID) ON DELETE CASCADE ON UPDATE RESTRICT;\p\g

INSERT INTO SBI_DATA_SET_HISTORY
(DS_ID,ACTIVE,VERSION_NUM,FILE_NAME,QUERY,JCLASS_NAME,SCRIPT,PARAMS,DS_METADATA
	,DATA_SOURCE_ID,OBJECT_TYPE,OPERATION,TRANSFORMER_ID,PIVOT_COLUMN,PIVOT_ROW
	,PIVOT_VALUE,NUM_ROWS,LANGUAGE_SCRIPT,USER_IN, TIME_IN)
SELECT DS_ID,true ACTIVE,1 VERSION_NUM,FILE_NAME,QUERY,JCLASS_NAME,SCRIPT,PARAMS,DS_METADATA,DATA_SOURCE_ID
,OBJECT_TYPE,OPERATION,TRANSFORMER_ID,PIVOT_COLUMN,PIVOT_ROW,PIVOT_VALUE,NUM_ROWS,LANGUAGE_SCRIPT
,'biadmin' USER_IN, now() TIME_IN
FROM SBI_DATA_SET;\p\g

commit;\p\g

--Drop all SBI_DATA_SET foreign keys
ALTER TABLE SBI_DATA_SET DROP FOREIGN KEY FK_SBI_DATA_SET_1;\p\g

ALTER TABLE SBI_DATA_SET DROP COLUMN EXECUTOR_CLASS;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN FILE_NAME;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN QUERY;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN JCLASS_NAME;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN SCRIPT;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN PARAMS;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN DS_METADATA;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN DATA_SOURCE_ID;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN OBJECT_TYPE;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN OPERATION;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN TRANSFORMER_ID;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN PIVOT_COLUMN;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN PIVOT_ROW;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN PIVOT_VALUE;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN NUM_ROWS;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN LANGUAGE_SCRIPT;\p\g
ALTER TABLE SBI_DATA_SET DROP COLUMN ADRESS;\p\g

ALTER TABLE SBI_DATA_SET ADD COLUMN USER_IN VARCHAR(100) NOT NULL;\p\g
ALTER TABLE SBI_DATA_SET ADD COLUMN USER_UP VARCHAR(100);\p\g 
ALTER TABLE SBI_DATA_SET ADD COLUMN USER_DE VARCHAR(100);\p\g
ALTER TABLE SBI_DATA_SET ADD COLUMN TIME_IN TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP;\p\g
ALTER TABLE SBI_DATA_SET ADD COLUMN TIME_UP TIMESTAMP NULL DEFAULT NULL;\p\g
ALTER TABLE SBI_DATA_SET ADD COLUMN TIME_DE TIMESTAMP NULL DEFAULT NULL;\p\g
ALTER TABLE SBI_DATA_SET ADD COLUMN SBI_VERSION_IN VARCHAR(10);\p\g 
ALTER TABLE SBI_DATA_SET ADD COLUMN SBI_VERSION_UP VARCHAR(10);\p\g 
ALTER TABLE SBI_DATA_SET ADD COLUMN SBI_VERSION_DE VARCHAR(10);\p\g 
ALTER TABLE SBI_DATA_SET ADD COLUMN META_VERSION VARCHAR(100);\p\g 
ALTER TABLE SBI_DATA_SET ADD COLUMN ORGANIZATION VARCHAR(20);\p\g 

UPDATE SBI_DATA_SET SET USER_IN = 'biadmin';\p\g